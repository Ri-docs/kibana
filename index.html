<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RapidIdentity Kibana Query Builder</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 text-gray-800 antialiased">
  <header class="bg-sky-700 text-white shadow">
    <div class="max-w-5xl mx-auto flex items-center justify-between px-4 py-4">
      <h1 class="text-xl font-semibold tracking-wide">
        RapidIdentity Kibana Query Builder
      </h1>
      <div class="text-xs sm:text-sm opacity-80">
        Uses localStorage in this browser
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-8 space-y-10">
    <section class="bg-white rounded-lg shadow p-4 sm:p-6 space-y-4">
      <h2 class="text-lg font-semibold text-sky-700">
        Build a query
      </h2>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
        <div class="space-y-2">
          <label class="block font-medium" for="queryNameInput">
            Query name
          </label>
          <input
            id="queryNameInput"
            type="text"
            class="w-full border rounded px-2 py-1"
            placeholder="Example: Auth failures for user"
          />
        </div>

        <div class="space-y-2">
          <label class="block font-medium" for="tenantIdInput">
            Tenant id
          </label>
          <input
            id="tenantIdInput"
            type="text"
            class="w-full border rounded px-2 py-1"
            placeholder="Example: iaf3a7..."
          />
          <p class="text-xs text-gray-500">
            Namespace will be built as idaas-tenantId. If blank, it uses idaas-TENANT_ID.
          </p>
        </div>

        <div class="space-y-2">
          <label class="block font-medium" for="messageTextInput">
            Keywords in message (optional)
          </label>
          <input
            id="messageTextInput"
            type="text"
            class="w-full border rounded px-2 py-1"
            placeholder="Example: Authentication FAILURE"
          />
        </div>

        <div class="space-y-2">
          <label class="block font-medium" for="jobIdInput">
            Job id or name (optional)
          </label>
          <input
            id="jobIdInput"
            type="text"
            class="w-full border rounded px-2 py-1"
            placeholder="Example: internal.safeIdScan"
          />
        </div>

        <div class="space-y-2">
          <label class="block font-medium" for="podNameInput">
            Pod name (optional)
          </label>
          <input
            id="podNameInput"
            type="text"
            class="w-full border rounded px-2 py-1"
            placeholder="Example: ri-portal-7b9d9b7db8-xyz9v"
          />
        </div>

        <div class="space-y-2">
          <label class="block font-medium" for="ingressIpInput">
            Ingress IP httpRequest.remoteIp (optional)
          </label>
          <input
            id="ingressIpInput"
            type="text"
            class="w-full border rounded px-2 py-1"
            placeholder="Example: 203.0.113.42"
          />
          <div class="flex items-center gap-2 mt-1">
            <input
              id="allTenantsCheckbox"
              type="checkbox"
              class="h-4 w-4"
            />
            <label for="allTenantsCheckbox" class="text-xs text-gray-600">
              For ingress search, do not add kubernetes.namespace filter (all tenants)
            </label>
          </div>
        </div>
      </div>

      <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 mt-2">
        <button
          id="createQueryButton"
          class="px-4 py-2 rounded bg-sky-700 text-white text-sm font-medium hover:bg-sky-800"
        >
          Create and save query
        </button>

        <button
          id="justBuildButton"
          class="px-4 py-2 rounded border border-sky-700 text-sky-700 text-sm font-medium hover:bg-sky-50"
        >
          Build query without saving
        </button>

        <div class="relative ml-auto">
          <button
            id="savedQueriesToggle"
            class="px-3 py-2 rounded bg-gray-100 border border-gray-300 text-sm flex items-center gap-1 hover:bg-gray-200"
          >
            <span>Saved queries</span>
            <svg class="w-4 h-4" viewBox="0 0 20 20" fill="none">
              <path d="M5 7l5 6 5-6H5z" fill="currentColor" />
            </svg>
          </button>
          <div
            id="savedQueriesMenu"
            class="hidden absolute right-0 mt-2 w-72 sm:w-80 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-20"
          >
            <div id="savedQueriesList" class="py-1 max-h-72 overflow-y-auto text-sm"></div>
          </div>
        </div>
      </div>

      <div id="statusMessage" class="text-xs mt-2 h-5 flex items-center text-gray-600"></div>

      <div class="mt-4">
        <label class="block text-sm font-medium mb-2" for="queryOutput">
          Generated JSON query (paste into Kibana Discover edit query)
        </label>
        <textarea
          id="queryOutput"
          class="w-full h-72 border rounded px-2 py-2 font-mono text-xs sm:text-sm"
          spellcheck="false"
        ></textarea>
      </div>
    </section>

    <section class="bg-white rounded-lg shadow p-4 sm:p-6 text-sm space-y-2">
      <h2 class="text-lg font-semibold text-sky-700">
        Query builder notes
      </h2>
      <ul class="list-disc list-inside space-y-1">
        <li>By default a kubernetes.namespace filter is added using idaas-tenantId or idaas-TENANT_ID.</li>
        <li>If you set an ingress IP and tick the all tenants checkbox, the namespace filter is skipped.</li>
        <li>Keywords in message adds a match_phrase on message.</li>
        <li>Job id adds a match_phrase on clusteredJob_id.</li>
        <li>Pod name adds a term on kubernetes.pod.name.</li>
        <li>Ingress IP adds a term on httpRequest.remoteIp.</li>
      </ul>
    </section>
  </main>

  <div
    id="confirmDialog"
    class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-30 hidden"
  >
    <div class="bg-white rounded-lg shadow-lg p-4 w-72 sm:w-80">
      <h3 class="text-sm font-semibold mb-2" id="confirmTitle">Delete query</h3>
      <p class="text-sm text-gray-700 mb-4" id="confirmMessage">
        Are you sure you want to delete this saved query?
      </p>
      <div class="flex justify-end gap-2">
        <button
          id="confirmCancel"
          class="px-3 py-1 rounded border border-gray-300 text-sm"
        >
          Cancel
        </button>
        <button
          id="confirmOk"
          class="px-3 py-1 rounded bg-red-600 text-white text-sm"
        >
          Delete
        </button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "riKibanaQueries";
    let savedQueries = [];
    let pendingDeleteId = null;

    function safeLoadSavedQueries() {
      try {
        const raw = window.localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch (e) {
        return [];
      }
    }

    function persistSavedQueries() {
      try {
        window.localStorage.setItem(STORAGE_KEY, JSON.stringify(savedQueries));
      } catch (e) {
      }
    }

    function getNamespaceValue(tenantId) {
      const trimmed = tenantId.trim();
      if (!trimmed) return "idaas-TENANT_ID";
      return "idaas-" + trimmed;
    }

    function buildQueryObject() {
      const tenantId = document.getElementById("tenantIdInput").value || "";
      const messageText = document.getElementById("messageTextInput").value || "";
      const jobId = document.getElementById("jobIdInput").value || "";
      const podName = document.getElementById("podNameInput").value || "";
      const ingressIp = document.getElementById("ingressIpInput").value || "";
      const allTenants = document.getElementById("allTenantsCheckbox").checked;

      const namespace = getNamespaceValue(tenantId);
      const filter = [];
      const must = [];

      const trimmedIngress = ingressIp.trim();
      const trimmedMessage = messageText.trim();
      const trimmedJob = jobId.trim();
      const trimmedPod = podName.trim();

      const shouldSkipNamespace = allTenants && trimmedIngress.length > 0;

      if (!shouldSkipNamespace) {
        filter.push({ term: { "kubernetes.namespace": namespace } });
      }

      if (trimmedMessage) {
        must.push({ match_phrase: { message: trimmedMessage } });
      }

      if (trimmedJob) {
        filter.push({ match_phrase: { clusteredJob_id: trimmedJob } });
      }

      if (trimmedPod) {
        filter.push({ term: { "kubernetes.pod.name": trimmedPod } });
      }

      if (trimmedIngress) {
        filter.push({ term: { "httpRequest.remoteIp": trimmedIngress } });
      }

      if (!filter.length && !must.length) {
        return {
          query: {
            match_all: {}
          }
        };
      }

      const bool = {};
      if (filter.length) {
        bool.filter = filter;
      }
      if (must.length) {
        bool.must = must;
      }

      return {
        query: {
          bool: bool
        }
      };
    }

    function buildQueryJson() {
      const obj = buildQueryObject();
      return JSON.stringify(obj, null, 2);
    }

    function setStatus(message, isError) {
      const el = document.getElementById("statusMessage");
      el.textContent = message || "";
      if (!message) {
        el.className = "text-xs mt-2 h-5 flex items-center text-gray-600";
      } else if (isError) {
        el.className = "text-xs mt-2 h-5 flex items-center text-red-600";
      } else {
        el.className = "text-xs mt-2 h-5 flex items-center text-green-700";
      }
    }

    function renderSavedQueries() {
      const list = document.getElementById("savedQueriesList");
      list.innerHTML = "";
      if (!savedQueries.length) {
        const empty = document.createElement("div");
        empty.className = "px-4 py-2 text-gray-500 text-xs";
        empty.textContent = "No saved queries yet.";
        list.appendChild(empty);
        return;
      }
      savedQueries
        .slice()
        .sort(function (a, b) {
          return a.name.localeCompare(b.name);
        })
        .forEach(function (q) {
          const row = document.createElement("div");
          row.className = "flex items-center justify-between px-4 py-2 hover:bg-gray-50";

          const left = document.createElement("button");
          left.className = "flex-1 text-left text-sm text-gray-800 pr-2";
          left.textContent = q.name;
          left.addEventListener("click", function () {
            document.getElementById("queryNameInput").value = q.name;
            document.getElementById("queryOutput").value = q.query;
            const menu = document.getElementById("savedQueriesMenu");
            menu.classList.add("hidden");
            setStatus("Loaded saved query " + q.name + ".", false);
          });

          const delBtn = document.createElement("button");
          delBtn.className = "w-7 h-7 flex items-center justify-center text-gray-500 hover:text-red-600";
          delBtn.setAttribute("type", "button");
          delBtn.innerHTML =
            '<svg class="w-4 h-4" viewBox="0 0 20 20" fill="none">' +
            '<path d="M7 3h6v2h4v2h-1v9a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7H3V5h4V3zm2 2v-1h2v1H9zm-1 4v7h2V9H8zm4 0v7h2V9h-2z" fill="currentColor" />' +
            "</svg>";
          delBtn.addEventListener("click", function (event) {
            event.stopPropagation();
            openConfirmDelete(q);
          });

          row.appendChild(left);
          row.appendChild(delBtn);
          list.appendChild(row);
        });
    }

    function openConfirmDelete(query) {
      pendingDeleteId = query.id;
      const dialog = document.getElementById("confirmDialog");
      const message = document.getElementById("confirmMessage");
      message.textContent = 'Delete saved query "' + query.name + '"?';
      dialog.classList.remove("hidden");
    }

    function closeConfirmDialog() {
      const dialog = document.getElementById("confirmDialog");
      dialog.classList.add("hidden");
      pendingDeleteId = null;
    }

    function deletePendingQuery() {
      if (!pendingDeleteId) {
        closeConfirmDialog();
        return;
      }
      savedQueries = savedQueries.filter(function (q) {
        return q.id !== pendingDeleteId;
      });
      persistSavedQueries();
      renderSavedQueries();
      setStatus("Deleted saved query.", false);
      closeConfirmDialog();
    }

    function toggleSavedQueriesMenu() {
      const menu = document.getElementById("savedQueriesMenu");
      const isHidden = menu.classList.contains("hidden");
      if (isHidden) {
        renderSavedQueries();
        menu.classList.remove("hidden");
      } else {
        menu.classList.add("hidden");
      }
    }

    function setupEventHandlers() {
      const createButton = document.getElementById("createQueryButton");
      const justBuildButton = document.getElementById("justBuildButton");
      const toggleButton = document.getElementById("savedQueriesToggle");
      const confirmCancel = document.getElementById("confirmCancel");
      const confirmOk = document.getElementById("confirmOk");

      createButton.addEventListener("click", function () {
        const queryNameInput = document.getElementById("queryNameInput");
        const name = queryNameInput.value.trim();
        if (!name) {
          setStatus("Please enter a query name before saving.", true);
          return;
        }
        const json = buildQueryJson();
        document.getElementById("queryOutput").value = json;
        const id = Date.now().toString() + "-" + Math.random().toString(16).slice(2);
        const newEntry = {
          id: id,
          name: name,
          query: json
        };
        savedQueries.push(newEntry);
        persistSavedQueries();
        renderSavedQueries();
        setStatus("Saved query " + name + " to localStorage.", false);
      });

      justBuildButton.addEventListener("click", function () {
        const json = buildQueryJson();
        document.getElementById("queryOutput").value = json;
        setStatus("Built query without saving.", false);
      });

      toggleButton.addEventListener("click", function () {
        toggleSavedQueriesMenu();
      });

      confirmCancel.addEventListener("click", function () {
        closeConfirmDialog();
      });

      confirmOk.addEventListener("click", function () {
        deletePendingQuery();
      });

      document.addEventListener("click", function (event) {
        const menu = document.getElementById("savedQueriesMenu");
        const toggle = document.getElementById("savedQueriesToggle");
        if (!menu.contains(event.target) && !toggle.contains(event.target)) {
          menu.classList.add("hidden");
        }
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      savedQueries = safeLoadSavedQueries();
      renderSavedQueries();
      setupEventHandlers();
      setStatus("", false);
    });
  </script>
</body>
</html>
